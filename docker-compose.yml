version: "3.8"

services:
  # ══════════════════════════════════════════════════════════════
  # 外部存储层 (External Storage Layer)
  # ══════════════════════════════════════════════════════════════

  # 向量数据库 - 存储文本向量、稀疏向量、图像向量
  qdrant:
    image: qdrant/qdrant:latest
    container_name: rag_qdrant
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 关系数据库 - 存储父节点、元数据、测试结果
  mysql:
    image: mysql:8.0
    container_name: rag_mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: rag_password
      MYSQL_DATABASE: rag_db
      MYSQL_USER: rag_user
      MYSQL_PASSWORD: rag_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init_mysql.sql:/docker-entrypoint-initdb.d/init.sql
    command: --default-authentication-plugin=mysql_native_password
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "rag_user", "-prag_password"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ══════════════════════════════════════════════════════════════
  # 微服务层 (Microservices Layer)
  # ══════════════════════════════════════════════════════════════

  # Indexing Service - 解析、切片、向量化、检索
  indexing:
    build:
      context: ./services/indexing
      dockerfile: Dockerfile
    container_name: rag_indexing
    ports:
      - "8001:8001"
    environment:
      - QDRANT_URL=http://qdrant:6333
      - MYSQL_URL=mysql+pymysql://rag_user:rag_password@mysql:3306/rag_db
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - AGENT_URL=http://agent:8002
    depends_on:
      - qdrant
      - mysql
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Agent Service - LLM/VLM 推理、ReAct 工作流
  agent:
    build:
      context: ./services/agent
      dockerfile: Dockerfile
    container_name: rag_agent
    ports:
      - "8002:8002"
    environment:
      - INDEXING_URL=http://indexing:8001
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
    depends_on:
      - indexing
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Testing Service - 通过 docker compose exec 运行 pytest
  testing:
    build:
      context: ./services/testing
      dockerfile: Dockerfile
    container_name: rag_testing
    environment:
      - MYSQL_URL=mysql+pymysql://rag_user:rag_password@mysql:3306/rag_db
      - INDEXING_URL=http://indexing:8001
      - AGENT_URL=http://agent:8002
    volumes:
      - ./services/testing/datas:/app/datas
      - ./services/testing/results:/app/results
    depends_on:
      - mysql
      - indexing
      - agent
    restart: unless-stopped
    networks:
      - rag_network

volumes:
  qdrant_data:
    driver: local
  mysql_data:
    driver: local

networks:
  rag_network:
    driver: bridge
