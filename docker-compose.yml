version: "3.8"

services:
  # ══════════════════════════════════════════════════════════════
  # 外部存储层 (External Storage Layer)
  # ══════════════════════════════════════════════════════════════

  # 向量数据库 - 存储文本向量、稀疏向量、图像向量
  qdrant:
    image: qdrant/qdrant:latest
    container_name: rag_qdrant
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 关系数据库 - 存储父节点、元数据、测试结果
  mysql:
    image: mysql:8.0
    container_name: rag_mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: rag_password
      MYSQL_DATABASE: rag_db
      MYSQL_USER: rag_user
      MYSQL_PASSWORD: rag_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init_mysql.sql:/docker-entrypoint-initdb.d/init.sql
    command: --default-authentication-plugin=mysql_native_password
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "rag_user", "-prag_password"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 对象存储 - 存储原始 PDF、提取的图片
  minio:
    image: minio/minio:latest
    container_name: rag_minio
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MinIO 初始化 - 创建 buckets
  minio-init:
    image: minio/mc:latest
    container_name: rag_minio_init
    depends_on:
      - minio
    networks:
      - rag_network
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/raw-documents --ignore-existing;
      mc mb myminio/extracted-images --ignore-existing;
      mc anonymous set download myminio/raw-documents;
      mc anonymous set download myminio/extracted-images;
      echo 'MinIO buckets initialized successfully';
      "

  # ══════════════════════════════════════════════════════════════
  # 微服务层 (Microservices Layer)
  # ══════════════════════════════════════════════════════════════

  # Indexing Service - 解析、切片、向量化、检索
  indexing:
    build:
      context: ./services/indexing
      dockerfile: Dockerfile
    container_name: rag_indexing
    ports:
      - "8001:8001"
    environment:
      - QDRANT_URL=http://qdrant:6333
      - MYSQL_URL=mysql+pymysql://rag_user:rag_password@mysql:3306/rag_db
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_SECURE=false
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - AGENT_URL=http://agent:8002
    depends_on:
      - qdrant
      - mysql
      - minio
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Agent Service - LLM/VLM 推理、ReAct 工作流
  agent:
    build:
      context: ./services/agent
      dockerfile: Dockerfile
    container_name: rag_agent
    ports:
      - "8002:8002"
    environment:
      - INDEXING_URL=http://indexing:8001
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
    depends_on:
      - indexing
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Orchestrator Service - 用户入口、流程编排
  orchestrator:
    build:
      context: ./services/orchestrator
      dockerfile: Dockerfile
    container_name: rag_orchestrator
    ports:
      - "8000:8000"
    environment:
      - INDEXING_URL=http://indexing:8001
      - AGENT_URL=http://agent:8002
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_SECURE=false
    depends_on:
      - indexing
      - agent
      - minio
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Testing Service - 集中测试管理
  testing:
    build:
      context: ./services/testing
      dockerfile: Dockerfile
    container_name: rag_testing
    ports:
      - "8003:8003"
    environment:
      - MYSQL_URL=mysql+pymysql://rag_user:rag_password@mysql:3306/rag_db
      - ORCHESTRATOR_URL=http://orchestrator:8000
      - INDEXING_URL=http://indexing:8001
      - AGENT_URL=http://agent:8002
    volumes:
      - ./services/testing/app/data:/app/app/data
    depends_on:
      - mysql
      - orchestrator
      - indexing
      - agent
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  qdrant_data:
    driver: local
  mysql_data:
    driver: local
  minio_data:
    driver: local

networks:
  rag_network:
    driver: bridge
